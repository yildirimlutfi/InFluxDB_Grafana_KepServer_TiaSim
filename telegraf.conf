# =========================
#  TELEGRAF – KEPServerEX → InfluxDB 3 Core
# =========================

[agent]
  interval = "1s"
  round_interval = true
  flush_interval = "1s"
  omit_hostname = true

# -------- OPC UA'dan okuma (KEPServerEX) --------
[[inputs.opcua]]
  # Measurement adını doğrudan 'sensor' yapıyoruz (InfluxDB'deki table ile aynı)
  name = "sensor"

  # Kepware OPC UA endpoint (varsayılan port 49320)
  endpoint = "opc.tcp://127.0.0.1:49320"

  # Güvenlik (Basic256Sha256 + Sign&Encrypt)
  security_policy = "Basic256Sha256"
  security_mode   = "SignAndEncrypt"

  # Test ortamı: Anonymous (Kepware tarafında anonime izin verilmeli)
  auth_method = "Anonymous"

  # 1 saniye abonelik periyodu
  subscription_interval = "1s"

  # KEPServerEX'de tipik NodeID düzeni: ns=2;s=<Channel>.<Device>.<Tag>
  # Senin gerçek tag'lerin:
  nodes = [
    {name = "temperature", namespace = 2, identifier_type = "s", identifier = "TCP/IP.1500.temperature"},
    {name = "location",    namespace = 2, identifier_type = "s", identifier = "TCP/IP.1500.location"}
  ]

# -------- Field/Tag düzeni --------
# 'location' PLC'den string field olarak gelirse, bunu TAG'e çeviriyoruz.
# 'temperature'ı da float'a zorluyoruz (tip karmaşasını engeller).
[[processors.converter]]
  namepass = ["sensor"]
  [processors.converter.fields]
    tag   = ["location"]
    float = ["temperature"]

# -------- InfluxDB 3 Core çıkışı --------
[[outputs.influxdb_v2]]
  urls = ["http://localhost:8181"]
  token = "apiv3_NnBwmn71nPvlQ4q2ArzbRrW54krwQTQFIOD3KnZK6YmtYNtD6ZyBIr1LYZjeWscoFhbyGkhddIIhyquUTAWu1A"
  organization = ""          # V3 Core'da boş bırakılır
  bucket       = "plc_data"  # V3 Core'da 'bucket' = database adı
  content_encoding = "gzip"